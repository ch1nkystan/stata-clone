name: Build and Push to Docker Hub

on:
  push:
    branches:
      - 'dev-**'

jobs:
  build-stata-dev:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to DigitalOcean Container Registry
      run: echo "${{ secrets.DO_REGISTRY_PASS }}" | docker login --username ${{ secrets.DO_REGISTRY_USER }} --password-stdin ${{ secrets.DO_REGISTRY_URL }}

    - name: Build and tag Docker image
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        docker build -f Dockerfile.server -t ${{ secrets.DO_REGISTRY_URL }}/trendtonic/stata:server_${BRANCH_NAME} .

    - name: Push Docker image to DigitalOcean
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        docker push ${{ secrets.DO_REGISTRY_URL }}/trendtonic/stata:server_${BRANCH_NAME}